<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Traitify Widgets</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
    <link href="data:," rel="icon"> <!-- Skip Favicon -->
  </head>
  <body>
    <div class="row">
      <div id="slide-deck"></div>
      <div id="results"></div>
      <div id="careers"></div>
      <div id="guide"></div>
    </div>
    <style>
      .dark {
        background: #555555;
        color: #FFFFFF;
      }
      .row { margin: 12px; }
      .hide { display: none; }
      @media(min-width: 60em) {
        .row {
          margin-left: 48px;
          margin-right: 48px;
        }
      }
      @media(prefers-color-scheme: dark) {
        .auto {
          background: #555555;
          color: #FFFFFF;
        }
      }
    </style>
    <div class="row">
      <label htmlFor="survey-type">
        Survey Type:
        <select id="survey-type" name="survey-type">
          <option value="cognitive">Cognitive</option>
          <option value="personality">Personality</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="survey-id">
        Survey:
        <select id="survey-id" name="survey-id">
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="deck-id">
        Deck:
        <select id="deck-id" name="deck-id">
          <option value="big-five">Big Five</option>
          <option value="career-deck">Career Deck</option>
          <option value="core">Core</option>
          <option value="financial-risk-tolerance-2.0">Financial Risk Tolerance</option>
          <option value="perseverance">Perseverance</option>
          <option value="persuasion">Persuasion</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="color-scheme">
        Color Scheme:
        <select id="color-scheme" name="color-scheme">
          <option value="">Default</option>
          <option value="auto">Auto</option>
          <option value="dark">Dark</option>
          <option value="light">Light</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="locale">
        Locale:
        <select id="locale" name="locale">
          <option value="zh-cn">Chinese</option>
          <option value="ht-us">Creole</option>
          <option value="nl-nl">Dutch</option>
          <option value="en-us">English (US)</option>
          <option value="en-gb">English (GB)</option>
          <option value="fr-ca">French (Canadian)</option>
          <option value="fr-fr">French (France)</option>
          <option value="de-de">German</option>
          <option value="ja-jp">Japanese</option>
          <option value="no-no">Norwegian</option>
          <option value="pt-br">Portuguese (Brazil)</option>
          <option value="pt-pt">Portuguese</option>
          <option value="ru-ru">Russian</option>
          <option value="es-us">Spanish</option>
          <option value="es-ec">Spanish (Ecuador)</option>
          <option value="sv-se">Swedish</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="perspective">
        Perspective:
        <select id="perspective" name="perspective">
          <option value="">Default</option>
          <option value="firstPerson">First Person</option>
          <option value="thirdPerson">Third Person</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="theme">
        Theme:
        <select id="theme" name="theme">
          <option value="">Default</option>
          <option value="paradox">Paradox</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label htmlFor="view">
        View:
        <select id="view" name="view">
          <option value="">Default</option>
          <option value="candidate">Candidate</option>
          <option value="employee">Employee</option>
        </select>
      </label>
    </div>
    <div class="row">
      Additional Components
      <label htmlFor="show-careers">
        <input id="show-careers" name="show-careers" type="checkbox" />
        Careers
      </label>
      <label htmlFor="show-guide">
        <input id="show-guide" name="show-guide" type="checkbox" />
        Guide
      </label>
    </div>
    <div class="row">
      <button onclick="createAssessment()">New Assessment</button>
      <button onclick="refreshWidget()">Refresh Widget</button>
      <button onclick="destroyWidget()">Destroy Widget</button>
    </div>
    <script src="build/traitify.js"></script>
    <script>
      Traitify.setPublicKey("sptoechv411aqbqrp4l9a4eg2a");
      Traitify.setHost("https://api.traitify.com");

      var widget;

      function createWidget(){
        var colorScheme = localStorage.getItem("color-scheme");
        var deckID = localStorage.getItem("deck-id");
        var locale = localStorage.getItem("locale");
        var perspective = localStorage.getItem("perspective");
        var showCareers = localStorage.getItem("show-careers");
        var showGuide = localStorage.getItem("show-guide");
        var surveyType = localStorage.getItem("survey-type");
        var theme = localStorage.getItem("theme");
        var view = localStorage.getItem("view");
        var assessmentID = localStorage.getItem(surveyType === "cognitive" ? "test-id" : "assessment-id");
        if(!assessmentID){ return; }

        targets = {
          "SlideDeck": "#slide-deck",
          "Results": "#results"
        }

        if(surveyType !== "cognitive") {
          if(showCareers) { targets["Careers"] = "#careers"; }
          if(showGuide) { targets["Guide"] = "#guide"; }
        }

        widget = Traitify.ui.component();
        widget
          .allowBack()
          .allowFullscreen()
          .allowHeaders()
          .allowInstructions()
          .assessmentID(assessmentID)
          .colorScheme(colorScheme)
          .locale(locale)
          .perspective(perspective)
          .surveyType(surveyType)
          .theme(theme)
          .view(view)
          .targets(targets);
        widget.options.slideDeck.captureLearningDisability = true;
        widget.options.slideDeck.disableTimeLimit = true;
        widget.options.slideDeck.initialLearningDisability = true;
        widget.render().then(function(){
          console.log("Rendered");
        }).catch(function(error){
          console.log(error);
        });

        updateColorScheme();
      }

      function createAssessment(){
        destroyWidget();

        var surveyType = document.querySelector("#survey-type").value
        if(surveyType === "cognitive") {
          var query = Traitify.graphql.queries.cognitive.create({
            params: {
              localeKey: document.querySelector("#locale").value,
              surveyId: document.querySelector("#survey-id").value
            }
          });

          Traitify.post("/cognitive-tests/graphql", query).then(function(response) {
            try{
              localStorage.setItem("test-id", response.data.createCognitiveTest.id);
            }catch(error){
              console.log(error);
            }
            setTimeout(createWidget, 500);
          });
        } else {
          Traitify.post("/assessments", {
            deck_id: document.querySelector("#deck-id").value,
            locale_key: document.querySelector("#locale").value,
            package_id: "cfc05114-b8af-43fb-af27-c175e0cc25ee"
          }).then(function(assessment){
            try{
              localStorage.setItem("assessment-id", assessment.id);
              localStorage.setItem("deck-id", assessment.deck_id);
            }catch(error){
              console.log(error);
            }
            setTimeout(createWidget, 500);
          });
        }
      }

      function destroyWidget(){
        if(widget){ widget.destroy(); }
      }

      function onChange(e){
        var name = e.target.name;
        var value = e.target.type === "checkbox" ? e.target.checked : e.target.value;

        value ? localStorage.setItem(name, value) : localStorage.removeItem(name);

        if(widget && !["deck-id", "survey-id"].includes(name) && !name.startsWith("show-")) {
          if(name === "color-scheme") { name = "colorScheme"; }
          if(name === "survey-type") { name = "surveyType"; }

          widget[name](value);
        }

        var type = localStorage.getItem("survey-type");
        var element1 = document.querySelector(type == "cognitive" ? "#deck-id" : "#survey-id");
        var element2 = document.querySelector(type == "cognitive" ? "#survey-id" : "#deck-id");
        if(element1.closest && element1.classList) {
          element1.closest(".row").classList.add("hide");
          element2.closest(".row").classList.remove("hide");
        }
      }

      function refreshWidget(){
        if(widget) {
          var showCareers = localStorage.getItem("show-careers");
          var showGuide = localStorage.getItem("show-guide");
          var surveyType = localStorage.getItem("survey-type");
          var assessmentID = localStorage.getItem(surveyType === "cognitive" ? "test-id" : "assessment-id");

          targets = {
            "SlideDeck": "#slide-deck",
            "Results": "#results"
          }

          if(surveyType !== "cognitive") {
            if(showCareers) { targets["Careers"] = "#careers"; }
            if(showGuide) { targets["Guide"] = "#guide"; }
          }

          widget.assessmentID(assessmentID).targets(targets).refresh();

          updateColorScheme();
        }
      }

      function setupOptions(){
        var inputs = [
          "color-scheme",
          "deck-id",
          "locale",
          "perspective",
          "show-careers",
          "show-guide",
          "survey-id",
          "survey-type",
          "theme",
          "view"
        ];
        for(var i = 0; i < inputs.length; i++) {
          var name = inputs[i];
          var element = document.querySelector("#" + name);
          var value = localStorage.getItem(name);

          if(!value) {
            switch(name) {
              case "deck-id":
                value = "big-five";
                localStorage.setItem(name, value);
                break;
              case "locale":
                value = "en-us";
                localStorage.setItem(name, value);
                break;
              case "survey-type":
                value = "personality";
                localStorage.setItem(name, value);
                break;
            }
          }

          if(value) { element.type === "checkbox" ? element.checked = true : element.value = value; }
          element.addEventListener("change", onChange);
        }

        var type = localStorage.getItem("survey-type");
        var element1 = document.querySelector(type == "cognitive" ? "#deck-id" : "#survey-id");
        var element2 = document.querySelector(type == "cognitive" ? "#survey-id" : "#deck-id");
        if(element1.closest && element1.classList) {
          element1.closest(".row").classList.add("hide");
          element2.closest(".row").classList.remove("hide");
        }
      }

      function setupSurveys(){
        var query = Traitify.graphql.queries.cognitive.surveys();

        Traitify.post("/cognitive-tests/graphql", query).then(function(response)  {
          var values = [];
          var select = document.querySelector("#survey-id");

          response.data.cognitiveSurveys.edges.forEach(function(edge) {
            var survey = edge.node;
            var element = document.createElement("option");

            values.push(survey.id);
            element.value = survey.id;
            element.appendChild(document.createTextNode(survey.name));
            select.appendChild(element);
          });

          var currentValue = localStorage.getItem("survey-id");
          if(!values.includes || values.includes(currentValue)) {
            select.value = currentValue;
          } else {
            select.value = values[0];
          }
        });
      }

      function updateColorScheme(){
        var colorScheme = localStorage.getItem("color-scheme") || "light";
        var theme = localStorage.getItem("theme");
        if(theme !== "paradox") { colorScheme = "light"; }

        ["auto", "dark", "light"].forEach((scheme) => {
          if(document.body.classList.contains(scheme)) {
            if(colorScheme !== scheme) { document.body.classList.remove(scheme); }
          } else {
            if(colorScheme === scheme) { document.body.classList.add(scheme); }
          }
        });
      }

      setupSurveys();
      setupOptions();
      createWidget();
    </script>
  </body>
</html>
