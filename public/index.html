<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Traitify Widgets</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,minimal-ui">
    <link href="data:," rel="icon"> <!-- Skip Favicon -->
  </head>
  <body>
    <div class="row">
      <div id="slide-deck"></div>
      <div id="results"></div>
      <div id="careers"></div>
      <div id="guide"></div>
      <div id="traits"></div>
    </div>
    <style>
      .dark {
        background: #555555;
        color: #FFFFFF;
      }
      .hide { display: none; }
      .row { margin: 12px; }
      .row .row { display: block; margin: 12px; }
      @media(min-width: 960px) {
        .flex { display: flex; }
        .row {
          margin-left: 48px;
          margin-right: 48px;
        }
      }
      @media(prefers-color-scheme: dark) {
        .auto {
          background: #555555;
          color: #FFFFFF;
        }
      }
    </style>
    <div class="flex">
      <div class="column">
        <div class="row">
          <label htmlFor="survey-type">
            Survey Type:
            <select id="survey-type" name="survey-type">
              <option value="cognitive">Cognitive</option>
              <option value="personality">Personality</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="survey-id">
            Survey:
            <select id="survey-id" name="survey-id">
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="deck-id">
            Deck:
            <select id="deck-id" name="deck-id">
              <option value="big-five">Big Five</option>
              <option value="career-deck">Career Deck</option>
              <option value="core">Core</option>
              <option value="financial-risk-tolerance-2.0">Financial Risk Tolerance</option>
              <option value="perseverance">Perseverance</option>
              <option value="persuasion">Persuasion</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="color-scheme">
            Color Scheme:
            <select id="color-scheme" name="color-scheme">
              <option value="">Default</option>
              <option value="auto">Auto</option>
              <option value="dark">Dark</option>
              <option value="light">Light</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="locale">
            Locale:
            <select id="locale" name="locale">
              <option value="zh-cn">Chinese</option>
              <option value="ht-us">Creole</option>
              <option value="nl-nl">Dutch</option>
              <option value="en-us">English (US)</option>
              <option value="en-gb">English (GB)</option>
              <option value="fr-ca">French (Canadian)</option>
              <option value="fr-fr">French (France)</option>
              <option value="de-de">German</option>
              <option value="it-it">Italian</option>
              <option value="ja-jp">Japanese</option>
              <option value="no-no">Norwegian</option>
              <option value="pt-br">Portuguese (Brazil)</option>
              <option value="pt-pt">Portuguese</option>
              <option value="ru-ru">Russian</option>
              <option value="es-us">Spanish</option>
              <option value="es-ec">Spanish (Ecuador)</option>
              <option value="sv-se">Swedish</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="perspective">
            Perspective:
            <select id="perspective" name="perspective">
              <option value="">Default</option>
              <option value="firstPerson">First Person</option>
              <option value="thirdPerson">Third Person</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="theme">
            Theme:
            <select id="theme" name="theme">
              <option value="">Default</option>
              <option value="paradox">Paradox</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label htmlFor="view">
            View:
            <select id="view" name="view">
              <option value="">Default</option>
              <option value="candidate">Candidate</option>
              <option value="employee">Employee</option>
              <option value="manager">Manager</option>
            </select>
          </label>
        </div>
      </div>
      <div class="column" id="additional">
      </div>
    </div>
    <div class="row">
      <button onclick="refreshWidget()">Refresh Widget</button>
      <button onclick="destroyWidget()">Destroy Widget</button>
    </div>
    <div class="row" id="params">
    </div>
    <div class="row">
      <button onclick="createAssessment()">New Assessment</button>
    </div>
    <script src="build/traitify.js"></script>
    <script>
      Traitify.setPublicKey("sptoechv411aqbqrp4l9a4eg2a");
      Traitify.setHost("https://api.traitify.com");

      var additionalComponents = {careers: "Careers", guide: "Guide", traits: "Traits"};
      var additionalOptions = {allowBack: "Allow Back", allowFullscreen: "Allow Fullscreen", allowHeaders: "Allow Headers", allowInstructions: "Allow Instructions"};
      var defaultValues = {
        "deck-id": "big-five",
        locale: "en-us",
        "survey-type": "personality"
      };
      var widget;

      function booleanFrom(value, fallback) {
        if(value == "true") { return true; }
        if(value == "false") { return false; }
        if(value == true) { return true; }
        if(value == false) { return false; }
        if(fallback == undefined) { return false; }

        return fallback;
      }

      function createWidget() {
        var surveyType = localStorage.getItem("survey-type");
        var assessmentID = localStorage.getItem(surveyType === "cognitive" ? "test-id" : "assessment-id");
        if(!assessmentID) { return; }

        var colorScheme = localStorage.getItem("color-scheme");
        var deckID = localStorage.getItem("deck-id");
        var locale = localStorage.getItem("locale");
        var perspective = localStorage.getItem("perspective");
        var show = Object.keys(additionalComponents).reduce((components, name) => ({...components, [name]: localStorage.getItem(`show-${name}`)}), {});
        var targets = setTargets();
        var theme = localStorage.getItem("theme");
        var view = localStorage.getItem("view");

        widget = Traitify.ui.component();
        widget
          .assessmentID(assessmentID)
          .colorScheme(colorScheme)
          .locale(locale)
          .perspective(perspective)
          .surveyType(surveyType)
          .theme(theme)
          .view(view)
          .targets(targets);

        Object.keys(additionalOptions).forEach((name) => {
          let value = localStorage.getItem(name);

          if(value == null) { return; }
          if(name.startsWith("allow")) {
            widget[booleanFrom(value) ? name : name.replace("allow", "disable")]();
          } else {
            widget[name](value);
          }
        });

        widget.options.careersLink = "/";
        widget.options.slideDeck.captureLearningDisability = true;
        widget.options.slideDeck.disableTimeLimit = true;
        widget.options.slideDeck.initialLearningDisability = true;
        widget.options.slideDeck.practiceExamples = [
          {
            button: "View Examples",
            heading: "Instructions",
            text: "This assessment is about your ability to work out patterns and relationships between shapes.\n\nOn each screen you will see a grid with different shapes in it. One square is empty, as indicated by '?'.\n\nYour task is to identify how the shapes in the grid are related to each other.\n\nSelect the response that completes the grid.\n\nTo help you know what to expect, we'll show you some examples."
          },
          ({type}) => ({
            button: "View Next Example",
            heading: "Here's an Example",
            text: "In each square, the small shape is the same as the overlap of the intersecting shapes. The small shapes are shaded. The shape that completes the grid is therefore the bottom right shape.",
            video: `https://cdn.traitify.com/P10202/cognitive-practice-site/example-${type}.mp4`
          }),
          ({type}) => ({
            button: "Ready to Practice",
            heading: "Here's an Example",
            text: "The left square is a combination of the others in its row. The colors in the right square and the middle square are swapped. The shape that completes the grid is therefore the top left shape.",
            video: `https://cdn.traitify.com/P30201/cognitive-practice-site/example-${type}.mp4`
          }),
          {
            button: "Start Practice",
            heading: "Here's an Example",
            text: "Now it’s time to try a few practice items. First, here's some things to remember.\n\n- You may need to look from right to left, from top to bottom, etc., or you'll have to consider the entire grid overall.\n- Consider more than one aspect of the shapes. You might find the solution involves a combination of border color, shading, positions, number, overlap, and more.\n- Sometimes you'll have to move and rotate items in your mind.\n- And here’s a tip: you can use the answer choices as a clue to the solution."
          }
        ];
        widget.render().then(function() {
          console.log("Rendered");
        }).catch(function(error) {
          console.log(error);
        });

        updateColorScheme();
      }

      function createAssessment() {
        destroyWidget();

        var surveyType = document.querySelector("#survey-type").value
        if(surveyType === "cognitive") {
          var query = Traitify.graphql.queries.cognitive.create({
            params: {
              localeKey: document.querySelector("#locale").value,
              surveyId: document.querySelector("#survey-id").value
            }
          });

          Traitify.post("/cognitive-tests/graphql", query).then(function(response) {
            try {
              localStorage.setItem("test-id", response.data.createCognitiveTest.id);
            } catch(error) {
              console.log(error);
            }
            setTimeout(createWidget, 500);
          });
        } else {
          var params = {
            deck_id: document.querySelector("#deck-id").value,
            locale_key: document.querySelector("#locale").value
          };
          var customParams = JSON.parse(localStorage.getItem("params") || "{}");
          Object.keys(customParams).filter((key) => customParams[key])
            .forEach((key) => params[key] = customParams[key]);

          Traitify.post("/assessments", params).then(function(assessment) {
            try {
              localStorage.setItem("assessment-id", assessment.id);
              localStorage.setItem("deck-id", assessment.deck_id);
            }catch(error) {
              console.log(error);
            }
            setTimeout(createWidget, 500);
          });
        }
      }

      function destroyWidget() { if(widget) { widget.destroy(); } }

      function onChange(e) {
        var name = e.target.name;
        var value = e.target.type === "checkbox" ? e.target.checked : e.target.value;

        value == "" ? localStorage.removeItem(name) : localStorage.setItem(name, value);

        if(widget && !["deck-id", "survey-id"].includes(name) && !name.startsWith("show-")) {
          if(name === "color-scheme") { name = "colorScheme"; }
          if(name === "survey-type") { name = "surveyType"; }
          if(name.startsWith("allow")) {
            if(value == "") { value = name == "allowInstructions"; }

            widget[booleanFrom(value) ? name : name.replace("allow", "disable")]();
          } else {
            widget[name](value);
          }
        }

        var type = localStorage.getItem("survey-type");
        var element1 = document.querySelector(type == "cognitive" ? "#deck-id" : "#survey-id");
        var element2 = document.querySelector(type == "cognitive" ? "#survey-id" : "#deck-id");
        if(element1.closest && element1.classList) {
          element1.closest(".row").classList.add("hide");
          element2.closest(".row").classList.remove("hide");
        }
      }

      function refreshWidget() {
        if(!widget) { return; }

        var surveyType = localStorage.getItem("survey-type");
        var assessmentID = localStorage.getItem(surveyType === "cognitive" ? "test-id" : "assessment-id");
        var targets = setTargets();

        widget.assessmentID(assessmentID).targets(targets).refresh();

        updateColorScheme();
      }

      function setTargets() {
        var show = Object.keys(additionalComponents).reduce((components, name) => ({...components, [name]: localStorage.getItem(`show-${name}`)}), {});
        var surveyType = localStorage.getItem("survey-type");
        var targets = {
          "SlideDeck": "#slide-deck",
          "Results": "#results"
        };

        if(surveyType === "cognitive") { return targets; }
        if(show.careers) { targets["Careers"] = "#careers"; }
        if(show.guide) { targets["Guide"] = "#guide"; }
        if(show.traits) { targets["Candidate.PersonalityTraits"] = "#traits"; }

        return targets;
      }

      function setupAdditionalComponents() {
        var inputs = [];
        var element = document.createElement("div");
        element.appendChild(document.createTextNode("Additional Components: "));
        element.className = "row";
        Object.keys(additionalComponents).forEach((key) => {
          var id = `show-${key}`;
          var label = document.createElement("label");
          var input = document.createElement("input");
          input.id = id;
          input.name = id;
          input.type = "checkbox";
          label.appendChild(input);
          label.appendChild(document.createTextNode(additionalComponents[key]));
          label.htmlFor = id;
          element.appendChild(label);
          inputs.push(id);
        });

        document.querySelector("#additional").appendChild(element);

        return inputs;
      }

      function setupAdditionalOptions() {
        var element = document.createElement("div");
        var inputs = [];
        var options = [["Default", ""], ["Yes", true], ["No", false]];
        element.appendChild(document.createTextNode("Additional Options: "));
        element.className = "row";
        Object.keys(additionalOptions).forEach((key) => {
          var id = key;
          var label = document.createElement("label");
          var select = document.createElement("select");
          select.id = id;
          select.name = id;
          options.forEach((item) => {
            var option = document.createElement("option");
            option.appendChild(document.createTextNode(item[0]));
            option.value = item[1];
            select.appendChild(option);
          });
          label.appendChild(document.createTextNode(`${additionalOptions[key]}: `));
          label.appendChild(select);
          label.className = "row";
          label.htmlFor = id;
          element.appendChild(label);
          inputs.push(id);
        });

        document.querySelector("#additional").appendChild(element);

        return inputs;
      }

      function setupOptions() {
        var inputs = [
          "color-scheme",
          "deck-id",
          "locale",
          "perspective",
          "survey-id",
          "survey-type",
          "theme",
          "view"
        ];

        inputs.push(...setupAdditionalComponents());
        inputs.push(...setupAdditionalOptions());

        for(var i = 0; i < inputs.length; i++) {
          var name = inputs[i];
          var element = document.querySelector("#" + name);
          var value = localStorage.getItem(name);

          if(value == null && defaultValues.hasOwnProperty(name)) {
            value = defaultValues[name];
            localStorage.setItem(name, value);
          }

          if(value != null) { element.type === "checkbox" ? element.checked = booleanFrom(value) : element.value = value; }
          element.addEventListener("change", onChange);
        }

        var type = localStorage.getItem("survey-type");
        var element1 = document.querySelector(type == "cognitive" ? "#deck-id" : "#survey-id");
        var element2 = document.querySelector(type == "cognitive" ? "#survey-id" : "#deck-id");
        if(element1.closest && element1.classList) {
          element1.closest(".row").classList.add("hide");
          element2.closest(".row").classList.remove("hide");
        }
      }

      function setupParams() {
        var saveParams = () => {
          var params = {};
          document.querySelectorAll("#params input:not(#new-param-input)").forEach((input) => {
            params[input.name] = input.value;
          });

          localStorage.setItem("params", JSON.stringify(params));
        };

        var addParam = (name, value) => {
          var id = `param-${name}`;
          if(document.querySelector(`#${id}`)) { return; }

          document.querySelector("#new-param").insertAdjacentHTML("beforebegin", `
            <label class="row" for="${id}-input" id="${id}">
              ${name}: <input id="${id}-input" name="${name}" value="${value}"><button type="button">X</button>
            </label>
          `);
          document.querySelector(`#${id}-input`).addEventListener("change", saveParams);
          document.querySelector(`#${id} button`).addEventListener("click", (e) => {
            e.currentTarget.parentElement.remove();

            saveParams();
          });
        };

        document.querySelector("#params").appendChild(document.createTextNode("Params: "));
        document.querySelector("#params").insertAdjacentHTML("beforeend", `
          <label class="row" for="new-param-input" id="new-param">
            New Param: <input id="new-param-input" name="new-param-input"><button type="button">Add</button>
          </label>
        `);
        document.querySelector("#new-param button").addEventListener("click", (e) => {
          var target = e.currentTarget.parentElement.querySelector("input");
          if(target.value) {
            addParam(target.value, "");
            saveParams();
          }
          target.value = "";
        });

        var params = JSON.parse(localStorage.getItem("params") || "{}");
        Object.keys(params).forEach((key) => addParam(key, params[key]));
      }

      function setupSurveys() {
        var query = Traitify.graphql.queries.cognitive.surveys();

        Traitify.post("/cognitive-tests/graphql", query).then(function(response) {
          var values = [];
          var select = document.querySelector("#survey-id");

          response.data.cognitiveSurveys.edges.forEach(function(edge) {
            var survey = edge.node;
            var element = document.createElement("option");

            values.push(survey.id);
            element.value = survey.id;
            element.appendChild(document.createTextNode(survey.name));
            select.appendChild(element);
          });

          var currentValue = localStorage.getItem("survey-id");
          if(!values.includes || values.includes(currentValue)) {
            select.value = currentValue;
          } else {
            select.value = values[0];
          }
        });
      }

      function updateColorScheme() {
        var colorScheme = localStorage.getItem("color-scheme") || "light";
        var theme = localStorage.getItem("theme");
        if(theme !== "paradox") { colorScheme = "light"; }

        ["auto", "dark", "light"].forEach((scheme) => {
          if(document.body.classList.contains(scheme)) {
            if(colorScheme !== scheme) { document.body.classList.remove(scheme); }
          } else {
            if(colorScheme === scheme) { document.body.classList.add(scheme); }
          }
        });
      }

      setupParams();
      setupSurveys();
      setupOptions();
      createWidget();
    </script>
  </body>
</html>
